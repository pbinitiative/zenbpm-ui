
import fs from 'fs/promises';
import path from 'path';
import { exec } from 'child_process';
import 'dotenv/config';

async function generateSchemas() {
  const extractPathRegex = /^https?:\/\/[^/]+(\/[^?#]*)?/;

  const basePath =  process.env.VITE_API_BASE_URL
    .match(extractPathRegex)
    ?.[1] ?? "";

  try {
    const inputFile = path.resolve(process.cwd(), 'openapi/api.yaml');
    const bundledFile = path.resolve(process.cwd(), 'src/base/openapi/generated-api/api.bundled.json');
    const outputFile = path.resolve(process.cwd(), 'src/base/openapi/generated-api/generated-openapi-schemas.ts');

    // 1. Bundle the OpenAPI spec
    await new Promise((resolve, reject) => {
      exec(`pnpm exec swagger-cli bundle ${inputFile} --outfile ${bundledFile} --type json`, (error, stdout, stderr) => {
        if (error) {
          console.error(`Error bundling OpenAPI spec: ${stderr}`);
          reject(error);
        }
        console.log(stdout);
        resolve(stdout);
      });
    });

    // 2. Read the bundled JSON file
    const apiSpec = JSON.parse(await fs.readFile(bundledFile, 'utf-8'));

    // 3. Extract schemas
    const schemas = {};
    if (apiSpec.components && apiSpec.components.schemas) {
      for (const [schemaName, schema] of Object.entries(apiSpec.components.schemas)) {
        schemas[schemaName] = schema;
      }
    }

    const retypeKeysToString = (root) => {
      if (!root || typeof root !== "object") return;
      const stack = [root];
      while (stack.length > 0) {
        const obj = stack.pop();
        if (!obj || typeof obj !== "object") continue;
        if (
          obj.type === "integer" &&
          obj.format === "int64"
        ) {
          obj.type = "string";
          obj.pattern = '^\\d{15,25}$';
          delete obj.format;
        }
        for (const key of Object.keys(obj)) {
          const value = obj[key];
          if (value && typeof value === "object") {
            stack.push(value);
          }
        }
      }
    };
    retypeKeysToString(schemas)

    // 4. Extract endpoint schemas
    const endpointSchemas = {};
    if (apiSpec.paths) {
      for (const [path, pathItem] of Object.entries(apiSpec.paths)) {
        for (const [method, operation] of Object.entries(pathItem)) {
          if (['get', 'post', 'put', 'patch', 'delete'].includes(method.toLowerCase())) {
            const endpointKey = `${method.toUpperCase()} ${basePath}${path}`;
            const endpointSchema = {};

            if (operation.requestBody && operation.requestBody.content && operation.requestBody.content['application/json']) {
              const requestBodySchemaRef = operation.requestBody.content['application/json'].schema.$ref;
              if (requestBodySchemaRef) {
                endpointSchema.request = requestBodySchemaRef.split('/').pop();
              }
            }

            if (operation.responses) {
              for (const [responseCode, response] of Object.entries(operation.responses)) {
                if (responseCode.startsWith('2') && response.content && response.content['application/json']) {
                  const responseSchema = response.content['application/json'].schema;
                  if (responseSchema) {
                    if (responseSchema.$ref) {
                      endpointSchema.response = responseSchema.$ref.split('/').pop();
                    }
                  }
                }
              }
            }

            if (Object.keys(endpointSchema).length > 0) {
              endpointSchemas[endpointKey] = endpointSchema;
            }
          }
        }
      }
    }

    // 5. Generate the output file content
    const outputContent = `
// This file is auto-generated by a script. Do not edit it manually.
export const schemas = ${JSON.stringify(schemas, null, 2)};

export const endpointSchemas = ${JSON.stringify(endpointSchemas, null, 2)};
`;

    // 6. Write the output file
    await fs.writeFile(outputFile, outputContent);

    console.log(`âœ… OpenAPI schemas generated successfully at: ${outputFile}`);

  } catch (error) {
    console.error('Error generating OpenAPI schemas:', error);
    process.exit(1);
  }
}

generateSchemas();
